<!DOCTYPE html>
{% load static %}
<!--
* CoreUI Pro based Bootstrap Admin Template
* @version v3.2.0
* @link https://coreui.io/pro/
* Copyright (c) 2020 creativeLabs Łukasz Holeczek
* License (https://coreui.io/pro/license)
-->
<html lang="en">
  <head>
    <base href="./">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <meta name="description" content="CoreUI - Open Source Bootstrap Admin Template">
    <meta name="author" content="Łukasz Holeczek">
    <meta name="keyword" content="Bootstrap,Admin,Template,Open,Source,jQuery,CSS,HTML,RWD,Dashboard">
    <title>Employee | Shopfloor Reporting Application</title>
    <!-- Main styles for this application-->
    <link rel="stylesheet" href="{% static "css/style.css" %}">
    <!-- Icon CSS -->
    <link href="{% static "vendors/@coreui/icons/css/free.min.css" %}" rel="stylesheet">
    <link href="{% static "vendors/@coreui/icons/css/brand.min.css" %}" rel="stylesheet">
    <!-- Select CSS -->
    <link href="{% static "vendors/select2/css/select2.min.css" %}" rel="stylesheet">
    <link href="{% static "vendors/select2/css/select2-coreui.min.css" %}" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="{% static "customize/css/decorate.css" %}" rel="stylesheet">
  </head>
  <body class="c-app c-no-layout-transition">
    <!-- *** LEFT SIDE BAR *** -->
    {% include 'sidebar.html' %}
    <!-- *** RIGHT SIDE BAR *** -->
    <div class="c-wrapper">
      <!-- *** HEADER *** -->
      <header class="c-header c-header-light c-header-fixed">
        {% include 'header.html' %}
        <div class="c-subheader justify-content-between px-3">
          <!-- Breadcrumb-->
          <ol class="breadcrumb border-0 m-0 px-0 px-md-3">
            <li class="breadcrumb-item">Employee</li>
            <!-- Breadcrumb Menu-->
            <li class="breadcrumb-item active">
              {{employee.EmpID}}
            </li>
          </ol>
          <div class="c-subheader-nav d-md-down-none mfe-2">

          </div>
        </div>
      </header>
      <!-- *** BODY *** -->
      <div class="c-body">
        <main class="c-main">
          <div class="container-fluid">
            <div class="fade-in">
              <div class="row">
                <div class="col-md-3">
                  <div class="card">
                    <div class="card-header"><strong>Infomation</strong></div>
                    <div class="card-body">
                      <div class="small">
                        <div class="form-group row">
                          <label class="col-md-4 col-form-label text-right"><strong>Employee ID</strong></label>
                          <div class="col-md-8">
                            <input class="form-control form-control-sm" type="text" id="emp_id" value="{{employee.EmpID}}" readonly>
                          </div>
                        </div>
                        <div class="form-group row">
                          <label class="col-md-4 col-form-label text-right"><strong>Employee Name</strong></label>
                          <div class="col-md-8">
                            <input class="form-control form-control-sm" type="text" value="{{employee.EmpName}}" readonly>
                          </div>
                        </div>
                        <div class="form-group row">
                          <label class="col-md-4 col-form-label text-right"><strong>Section</strong></label>
                          <div class="col-md-8">
                            <input class="form-control form-control-sm" type="text" value="{{employee.Section}}" readonly>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="card">
                    <div class="card-header"><strong>Performance (Month)</strong></div>
                    <div class="card-body">
                      <div class="small">
                        <div class="form-group row">
                          <label class="col-md-4 col-form-label text-right"><strong>Setup Time</strong></label>
                          <div class="col-md-8">
                            <input class="form-control form-control-sm" type="text" id="setup_time" value="0" readonly>
                          </div>
                        </div>
                        <div class="form-group row">
                          <label class="col-md-4 col-form-label text-right"><strong>Oper Time</strong></label>
                          <div class="col-md-8">
                            <input class="form-control form-control-sm" type="text" id="oper_time" value="0" readonly>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-9">
                  <div class="card">
                    <div class="card-header">
                      <strong>Timeline</strong>
                      <div class="card-header-actions">
                        <input type="month" class="form-control form-control-sm" id="fmonth" value="{{fmonth}}" onkeydown="return false" required>
                        <input type="text" id="year" value="{{fmonth|slice:'0:4'}}" hidden>
                        <input type="text" id="month" value="{{fmonth|slice:'5:7'}}" hidden>
                      </div>
                    </div>
                    <div class="card-body">
                      <div class="row">
                        <div class="col-md-6 text-left">
                          <strong></strong>
                        </div>
                        <div class="col-md-6 text-right">
                          <span class="text-primary"><i class="c-icon cil-gauge"></i> Machine</span>
                          <span class="text-danger"><i class="c-icon cil-user"></i> Labor</span>
                        </div>
                      </div>
                      <div id="timeline"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
      <!-- *** FOOTER *** -->
      {% include 'footer.html' %}
    </div>
    <!-- CoreUI and necessary plugins-->
    <script src="{% static "vendors/@coreui/coreui-pro/js/coreui.bundle.min.js" %}"></script>
    <!--[if IE]><!-->
    <script src="{% static "vendors/@coreui/icons/js/svgxuse.min.js" %}"></script>
    <!--<![endif]-->
    <script src="{% static "vendors/jquery/js/jquery.min.js" %}"></script>
    <script src="{% static "vendors/select2/js/select2.min.js" %}"></script>
    <!-- Google Timeline JS -->
    <script src="{% static "vendors/google-timeline/js/loader.js" %}"></script>
    <!-- Custom -->
    <script src="{% static "customize/js/clock.js" %}"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function(event) {
        setTimeout(function() {
          document.body.classList.remove('c-no-layout-transition')
        }, 2000);
      });
      var graph_coef = 0.675;
      var month = $("#month").val();
      var year = $("#year").val();
      var emp_id = $("#emp_id").val();

      var rows = [];
      createDataRows(month, year);

      google.charts.load('current', {'packages':['timeline']});
      google.charts.setOnLoadCallback(drawChart);
      function drawChart() {
        var container = document.getElementById('timeline');
        var chart = new google.visualization.Timeline(container);
        var dataTable = new google.visualization.DataTable();
        var options = {
          hAxis: {
            minValue: new Date(0, 0, 0, 0, 0, 0),
            maxValue: new Date(0, 0, 0, 23, 59, 59)
          },
          tooltip: { isHtml: true },
          timeline: { rowLabelStyle: { fontSize: 12 }, barLabelStyle: { fontSize: 8 } },
          width: $(window).width() * graph_coef,
          height: $(window).height(),
        };
        // opacity: 0
        dataTable.addColumn({ type: 'string', id: 'Date' });
        dataTable.addColumn({ type: 'string', id: 'Title' });
        dataTable.addColumn({type: 'string', role: 'tooltip'});
        dataTable.addColumn({ type: 'string', role: 'style' });
        dataTable.addColumn({ type: 'date', id: 'Start' });
        dataTable.addColumn({ type: 'date', id: 'End' });
        createEmptyRows(dataTable, month, year);
        dataTable.addRows(rows);
        chart.draw(dataTable, options);
      }

      function createDataRows(month, year){
        $.ajax({
          url: '/get_emp_timeline/',
          data: {
            'emp_id': emp_id,
            'month': month,
            'year': year,
          },
          dataType: 'json',
          success: function (data) {
            for (var i = 0; i < data.empOperateList.length; i++) {
              console.log(data.empOperateList[i]);
              var orderoprno = data.empOperateList[i][0]+"-"+data.empOperateList[i][1];
              var work_center_no = data.empOperateList[i][9];
              var work_center_type = data.empOperateList[i][31];
              var work_center_no_machine = data.empOperateList[i][27];
              var emp_id = data.empOperateList[i][2];
              var emp_name = data.empOperateList[i][25];
              var operate_type = data.empOperateList[i][4];
              var start_date_time = new Date(data.empOperateList[i][5]);
              var stop_date_time = new Date(data.empOperateList[i][6]);
              var color = (work_center_type == "Labor")? '#e74c3c':'#4f88db';
              addPerformance(operate_type, getDiffMin(start_date_time, stop_date_time));
              var tooltip = tooltipEmployee(orderoprno, work_center_no, work_center_no_machine, work_center_type, operate_type, getTime(start_date_time), getTime(stop_date_time), getDiffMin(start_date_time, stop_date_time));
              rows.push([ start_date_time.getDate().toString(), '', tooltip, color, new Date(0, 0, 0, start_date_time.getHours(), start_date_time.getMinutes(), start_date_time.getSeconds()), new Date(0, 0, 0, stop_date_time.getHours(), stop_date_time.getMinutes(), stop_date_time.getSeconds())]);
            }
          }
        });
      }

      function tooltipEmployee(orderoprno, work_center_no, work_center_no_machine, work_center_type, operate_type, start_time, end_time, mins){
        str = '<div style="width: 200px; padding: 5px;" class="text-center small">';
        if(work_center_type == "Labor") str += '<i class="c-icon c-icon-sm cil-user"></i>&nbsp;<br>';
        else str += '<i class="c-icon c-icon-sm cil-gauge"></i>&nbsp;<br>';
        if(work_center_type == "Machine") str += ''+operate_type+' ON '+work_center_no_machine+'<br>';
        str += '<strong>'+orderoprno+'</strong><br>';
        str += ''+work_center_no+'<br>';
        str += ''+start_time+' - '+end_time+'<br>'+mins+' minutes';
        str += '</div>';
        return str;
      }

      function createEmptyRows(dataTable, month, year){
        var days = 30;
        if(month == 2 && year%4 == 0) days = 29;
        else if(month == 2) days = 28;
        else if(month == 1 || month == 3 || month == 5 || month == 7 || month == 8 || month == 10 || month == 12) days = 31;
        for (var i = 1; i <= days; i++) {
          var text = year + "-" + month + "-" + frontZero(i.toString(), 2);
          var text = frontZero(i.toString(), 2);
          dataTable.addRows([[ text, '', '', 'opacity: 0', new Date(0, 0, 0, 0, 0, 0), new Date(0, 0, 0, 0, 0, 0)]]);
        }
      }

      function addPerformance(operate_type, time){
        if(operate_type.trim() == "OPERATE"){
          $("#oper_time").val(parseFloat($("#oper_time").val()) + time);
        } else if(operate_type.trim() == "SETUP"){
          $("#setup_time").val(parseFloat($("#setup_time").val()) + time);
        }
      }

      $(window).resize(function() {
        drawChart();
      });

      $(window).on('resizeEnd', function() {
          drawChart(data);
      });

      function frontZero(str, len){
        var result = str;
        for(var i = str.length;i < len;i++) result = "0" + result;
        return result;
      }

      function getTime(datetime) {
         var result = "";
         var hour = frontZero(datetime.getHours().toString(), 2);
         var minute = frontZero(datetime.getMinutes().toString(), 2);
         var second = frontZero(datetime.getSeconds().toString(), 2);
         result = hour+":"+minute+":"+second;
         return result
      }

      function getDiffMin(start_date_time, stop_date_time){
        var diff = Math.abs(stop_date_time - start_date_time);
        var minutes = Math.floor((diff/1000)/60);
        return minutes;
      }

      $('#fmonth').change(function() {
        window.location.href =  "/emp/" + ($("#emp_id").val() + "&" + $("#fmonth").val());
      });


    </script>
  </body>
</html>
