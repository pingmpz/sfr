<!DOCTYPE html>
{% load static %}
{% load extra %}
<!--
* CoreUI Pro based Bootstrap Admin Template
* @version v3.2.0
* @link https://coreui.io/pro/
* Copyright (c) 2020 creativeLabs Łukasz Holeczek
* License (https://coreui.io/pro/license)
-->
<html lang="en">
  <head>
    <base href="./">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <meta name="description" content="CoreUI - Open Source Bootstrap Admin Template">
    <meta name="author" content="Łukasz Holeczek">
    <meta name="keyword" content="Bootstrap,Admin,Template,Open,Source,jQuery,CSS,HTML,RWD,Dashboard">
    <title>Transaction | Shopfloor Reporting Application</title>
    <!-- Main styles for this application-->
    <link rel="stylesheet" href="{% static "css/style.css" %}">
    <!-- Icon CSS -->
    <link href="{% static "vendors/@coreui/icons/css/free.min.css" %}" rel="stylesheet">
    <link href="{% static "vendors/@coreui/icons/css/brand.min.css" %}" rel="stylesheet">
    <!-- Select CSS -->
    <link href="{% static "vendors/select2/css/select2.min.css" %}" rel="stylesheet">
    <link href="{% static "vendors/select2/css/select2-coreui.min.css" %}" rel="stylesheet">
    <!-- Custom CSS -->
    <style media="screen">
      .bg-yellowgreen {
          background-color:#9dd04d;
          color:white;
      }
      .text-yellowgreen {
          color:#9dd04d;
      }
      .bg-darkslategray {
          background-color:#30475e;
          color:white;
      }
      .bg-lavender {
          background-color:#dbf2f2;
          color:black;
      }
      .bg-plum {
          background-color:#b691ff;
          color:white;
      }
      .text-plum {
          color:#b691ff;
      }
      .my-btn {
        width: 90px;
      }
      .my-radio {
        width: 18px;
        height: 18px;
      }
      .blink {
        animation: blinker 1s step-start infinite;
      }

      @keyframes blinker {
        /* 10% { opacity: 0.1; } */
        20% { opacity: 0.2; }
        /* 30% { opacity: 0.3; } */
        40% { opacity: 0.4; }
        /* 50% { opacity: 0.5; } */
        60% { opacity: 0.6; }
        /* 70% { opacity: 0.7; } */
        80% { opacity: 0.8; }
        /* 90% { opacity: 0.9; } */
        100% { opacity: 1; }
      }
    </style>
  </head>
  <body class="c-app c-no-layout-transition">
    <!-- *** LEFT SIDE BAR *** -->
    {% include 'sidebar.html' %}
    <!-- *** RIGHT SIDE BAR *** -->
    <div class="c-wrapper">
      <!-- *** HEADER *** -->
      <header class="c-header c-header-light c-header-fixed">
        {% include 'header.html' %}
        <div class="c-subheader justify-content-between px-3">
          <!-- Breadcrumb-->
          <ol class="breadcrumb border-0 m-0 px-0 px-md-3">
            <li class="breadcrumb-item">Transaction</li>
            {% if isFirstPage == False %}
            <li class="breadcrumb-item active">
              {% if operationBefore != -1 %}<a href="/transaction/{{orderNo}}{{operationBefore}}" class="text-primary" style="padding-top: 3px;"><i class="c-icon cil-chevron-left"></i></a>&nbsp;{% endif %}
              <span id="bc_order_no">{{orderNo}}</span>&nbsp;-&nbsp;<span id="bc_operation_no">{{operationNo}}</span>
              {% if operationAfter != -1 %}&nbsp;<a href="/transaction/{{orderNo}}{{operationAfter}}" class="text-primary" style="padding-top: 3px;"><i class="c-icon cil-chevron-right"></i></a>{% endif %}
            </li>
            {% endif %}
            <!-- Breadcrumb Menu-->
          </ol>
          <div class="c-subheader-nav d-md-down-none mfe-2">
            &nbsp;&nbsp;<div>Prod. Order - Oper. No</div>
            &nbsp;&nbsp;<div><input type="text" class="form-control form-control-sm" maxlength="10" id="sc_order_no" autocomplete="off" value="{{orderNo}}"></div>
            &nbsp;&nbsp;<div>-</div>&nbsp;&nbsp;
            <div style="width:15%"><input type="text" class="form-control form-control-sm" maxlength="4" id="sc_operation_no" autocomplete="off" value="{{operationNo}}"></div>
            &nbsp;&nbsp;<div><button type="button" class="btn btn-sm bg-info text-white" onclick="shortcut_search()">GO!</button></div>
          </div>
        </div>
      </header>
      <!-- *** BODY *** -->
      <div class="c-body">
        <main class="c-main">
          <div class="container-fluid">
            <div class="fade-in">
              <input type="text" id="has_data" value="{% if isFirstPage == False and order != None and operation != None %}true{% else %}false{% endif %}" hidden>
              <!-- Main Body -->
              {% if isFirstPage == False and order != None and operation != None %}
              <div class="row" id="main_body">
                  <!-- Left Content -->
                  <div class="col-sm-12 col-md-4">
                    <div class="card border-secondary">
                      <div class="card-body">
                        <div class="form-group row">
                          <label class="col-md-4 col-form-label text-right"><strong>Production Order No</strong></label>
                          <div class="col-md-8">
                            <input class="form-control" type="text" id="order_no" value="{{orderNo}}" readonly>
                          </div>
                        </div>
                        <div class="form-group row">
                          <label class="col-md-4 col-form-label text-right"><strong>Operation No</strong></label>
                          <div class="col-md-8">
                            <input class="form-control" type="text" id="operation_no" value="{{operationNo}}" readonly>
                          </div>
                        </div>
                        <br>
                        <!-- Tab -->
                        <div class="nav-tabs-boxed">
                          <ul class="nav nav-tabs" role="tablist">
                            <li class="nav-item"><a class="nav-link active" data-toggle="tab" href="#operation-tab" role="tab" aria-controls="home">Operation</a></li>
                            <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#order-tab" role="tab" aria-controls="home">Production Order</a></li>
                            <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#structure-tab" role="tab" aria-controls="profile">Structure ({{operationList|length}})</a></li>
                          </ul>
                          <div class="tab-content">
                            <!-- Operation Tab -->
                            <div class="tab-pane active" id="operation-tab" role="tabpanel">
                              <div class="form-group row">
                                <label class="col-md-4 col-form-label text-right"><strong>Work Center</strong></label>
                                <div class="col-md-8">
                                  <input class="form-control" type="text" id="work_center" value="{{operation.WorkCenter}}" readonly>
                                </div>
                              </div>
                              <div class="form-group row">
                                <label class="col-md-4 col-form-label text-right"><strong>Plan Start</strong></label>
                                <div class="col-md-8">
                                  <input class="form-control" type="text" id="plan_start" value="{{operation.PlanStartDate}}" readonly>
                                </div>
                              </div>
                              <div class="form-group row">
                                <label class="col-md-4 col-form-label text-right"><strong>Plan Finish</strong></label>
                                <div class="col-md-8">
                                  <input class="form-control" type="text" id="plan_finish" value="{{operation.PlanFinishDate}}" readonly>
                                </div>
                              </div>
                              <div class="form-group row">
                                <label class="col-md-4 col-form-label text-right"><strong>Est. Setup Time</strong></label>
                                <div class="col-md-8">
                                  <input class="form-control" type="text" id="est_set_time" value="{{operation.EstimateSetTime}}" readonly>
                                </div>
                              </div>
                              <div class="form-group row">
                                <label class="col-md-4 col-form-label text-right"><strong>Est. Operation Time</strong></label>
                                <div class="col-md-8">
                                  <input class="form-control" type="text" id="est_operation_time" value="{{operation.EstimateOoperationTime}}" readonly>
                                </div>
                              </div>
                              <div class="form-group row">
                                <label class="col-md-4 col-form-label text-right"><strong>Est. Labor Time</strong></label>
                                <div class="col-md-8">
                                  <input class="form-control" type="text" id="est_labor_time" value="{{operation.EstimateLaborTime}}" readonly>
                                </div>
                              </div>
                              <hr>
                              <div class="form-group row">
                                <label class="col-md-4 col-form-label text-right text-info"><strong>Process Qty</strong></label>
                                <div class="col-md-8">
                                  <input class="form-control" type="text" id="process_qty" value="{{operation.ProcessQty}}" readonly>
                                </div>
                              </div>
                              <div class="form-group row">
                                <label class="col-md-4 col-form-label text-right text-warning"><strong>Remain Qty</strong></label>
                                <div class="col-md-8">
                                  <input class="form-control" type="text" id="remain_qty" value="{{remainQty}}" readonly>
                                </div>
                              </div>
                              <div class="form-group row">
                                <label class="col-md-4 col-form-label text-right text-success"><strong>Accepted Qty</strong></label>
                                <div class="col-md-8">
                                  <input class="form-control" type="text" id="accepted_qty" value="{{operation.AcceptedQty}}" readonly>
                                </div>
                              </div>
                              <div class="form-group row">
                                <label class="col-md-4 col-form-label text-right text-danger"><strong>Rejected Qty</strong></label>
                                <div class="col-md-8">
                                  <input class="form-control" type="text" id="rejected_qty" value="{{operation.RejectedQty}}" readonly>
                                </div>
                              </div>
                            </div>
                            <!-- Production Order Tab -->
                            <div class="tab-pane" id="order-tab" role="tabpanel">
                              <div class="form-group row">
                                <label class="col-md-4 col-form-label text-right"><strong>Customer PO No</strong></label>
                                <div class="col-md-8">
                                  <input class="form-control" type="text" id="customer_po_no" value="{{order.CustomerPONo}}" readonly>
                                </div>
                              </div>
                              <div class="form-group row">
                                <label class="col-md-4 col-form-label text-right"><strong>Part No</strong></label>
                                <div class="col-md-8">
                                  <input class="form-control" type="text" id="part_no" value="{{order.PartNo}}" readonly>
                                </div>
                              </div>
                              <div class="form-group row">
                                <label class="col-md-4 col-form-label text-right"><strong>Part Name</strong></label>
                                <div class="col-md-8">
                                  <input class="form-control" type="text" id="part_name" value="{{order.PartName}}" readonly>
                                </div>
                              </div>
                              <div class="form-group row">
                                <label class="col-md-4 col-form-label text-right"><strong>Material Code</strong></label>
                                <div class="col-md-8">
                                  <input class="form-control" type="text" id="material_code" value="{{order.FG_MaterialCode}}" readonly>
                                </div>
                              </div>
                              <div class="form-group row">
                                <label class="col-md-4 col-form-label text-right"><strong>Drawing No</strong></label>
                                <div class="col-md-8">
                                  <input class="form-control" type="text" id="drawing_no" value="{{order.DrawingNo}}" readonly>
                                </div>
                              </div>
                              <div class="form-group row">
                                <label class="col-md-4 col-form-label text-right"><strong>Prod. Order Qty</strong></label>
                                <div class="col-md-8">
                                  <input class="form-control" type="text" id="order_qty" value="{{order.ProductionOrderQuatity}}" readonly>
                                </div>
                              </div>
                              <div class="form-group row">
                                <label class="col-md-4 col-form-label text-right"><strong>Request Date</strong></label>
                                <div class="col-md-8">
                                  <input class="form-control" type="text" id="request_date" value="{{order.request_date}}" readonly>
                                </div>
                              </div>
                            </div>
                            <!-- Structure Tab -->
                            <div class="tab-pane" id="structure-tab" role="tabpanel">
                              <table class="table table-sm table-responsive-sm table-outline text-center">
                                <thead class="bg-darkslategray">
                                  <tr>
                                    <th>Status</th>
                                    <th>Operation No</th>
                                    <th>Work Center</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  {% for operation in operationList %}
                                  <tr {% if operation.OperationNumber.strip == operationNo.strip %}class="bg-lavender"{% endif %}>
                                    <td>
                                      {% if operationStatusList|index:forloop.counter0 == 'COMPLETED' %}<i class="c-icon cib-discover text-success"></i>
                                      {% elif operationStatusList|index:forloop.counter0 == 'WORKING' %}<i class="c-icon cib-discover text-warning"></i>
                                      {% elif operationStatusList|index:forloop.counter0 == 'ERROR' %}<i class="c-icon cib-discover text-danger"></i>
                                      {% endif %}
                                    </td>
                                    <td>
                                      {% if operation.OperationNumber != operationNo %}
                                      <a href="/transaction/{{orderNo}}{{operation.OperationNumber}}">{{operation.OperationNumber}}</a>
                                      {% else %}
                                      {{operation.OperationNumber}}
                                      {% endif %}
                                    </td>
                                    <td>{{operation.WorkCenter}}</td>
                                  </tr>
                                  {% endfor %}
                                </tbody>
                              </table>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Right Content -->
                  <div class="col-sm-12 col-md-8">
                    <div class="row">
                      <!-- Button Group -->
                      <div class="col-md-6 text-left">
                        <button type="button" class="btn btn-lg btn-success my-btn small" data-toggle="modal" data-target="#add_modal"><i class="c-icon c-icon-xl cil-plus"></i><br>Add</button>
                        <button type="button" class="btn btn-lg btn-warning my-btn text-white small" data-toggle="modal" data-target="#change_modal"><i class="c-icon c-icon-xl cil-transfer"></i><br>Change</button>
                        <button type="button" class="btn btn-lg btn-danger my-btn small" data-toggle="modal" data-target="#delete_modal"><i class="c-icon c-icon-xl cil-trash"></i><br>Delete</button>
                        <p></p>
                      </div>
                      <div class="col-md-6 text-right">
                        {% if remainQty != 0 %}
                        <a type="button" class="btn btn-lg btn-primary my-btn small" href="/join_activity/{{orderNo}}{{operationNo}}"><i class="c-icon c-icon-xl cil-fullscreen-exit"></i><br>Join</a>
                        <button type="button" class="btn btn-lg btn-danger my-btn small" disabled><i class="c-icon c-icon-xl cil-fullscreen"></i><br>Break Join</button>
                        {% endif %}
                        {% if joinList|length > 0 %}
                        <button type="button" class="btn btn-lg btn-primary text-white my-btn small" data-toggle="modal" data-target="#join_list_modal"><i class="c-icon c-icon-xl cil-list"></i><br>Join List</button>
                        {% endif %}
                        <button type="button" class="btn btn-lg btn-info text-white my-btn small" data-toggle="modal" data-target="#history_modal"><i class="c-icon c-icon-xl cil-history"></i><br>History</button>
                        <a href="/transaction/0" class="btn btn-lg btn-dark my-btn small"><i class="c-icon c-icon-xl cil-account-logout"></i><br>Exit</a>
                        <p></p>
                      </div>
                      {% if remainQty > 0 %} <!-- *** START CONDITION 1 *** -->
                      {% if operation.JoinToOrderNo == None and operation.JoinToOperationNo == None %} <!-- *** START CONDITION 2 *** -->
                      <!-- Machine/Operator -->
                      <div class="col-md-12">
                        <div class="card border-secondary">
                          <div class="card-header">
                            <strong>Machine/Operator</strong>
                            <a class="badge badge-pill badge-secondary" tabindex="0" role="button" data-toggle="popover" data-trigger="focus" data-html="true" title="Tips"
                            data-content="
                            - <strong class='text-danger'>Stop Working</strong> on manual machine will automactically stop machine.<br>
                            - You can ignore <strong class='text-primary'>Confirm</strong> and let operator after you confirm all quantity.<br>
                            - User working on <strong class='text-plum'>External Process</strong> can still work on other operations.<br>
                            - <strong class='text-plum'>External Process</strong> only keep startdatetime and stopdatetime, but not working time.<br>
                            ">?
                            </a>
                          </div>
                          <div class="card-body">
                            <div hidden>
                              <input type="text" id="machine_type" value="{{operation.MachineType}}">
                            </div>
                            {% if operation.MachineType == 'Machine' %}
                            <div class="form-group row">
                              <label class="col-md-2 col-form-label text-right"><strong><i class="c-icon c-icon-sm cil-plus"></i> Machine</strong></label>
                              <div class="col-md-2">
                                <input class="form-control" type="text" id="machine_no" autocomplete="off" value="">
                              </div>
                              <div class="col-md-5">
                                <input class="form-control" type="text" id="machine_name" value="" readonly>
                              </div>
                              <div class="col-md-2"><button type="button" class="btn btn-pill btn-info" id='machine_add_button' onclick="add_tmc()" disabled>Add</button></div>
                            </div>
                            <table class="table table-sm table-outline text-center" style="table-layout:fixed;" id="machine_table">
                              <thead class="bg-darkslategray">
                                <tr>
                                  <th></th>
                                  <th>Machine</th>
                                  <th>Status</th>
                                  <th>Start Time</th>
                                  <th></th>
                                </tr>
                              </thead>
                              <tbody id="machine_table_body">

                              </tbody>
                            </table>
                            {% endif %}
                            <div class="form-group row">
                              <label class="col-md-2 col-form-label text-right"><strong><i class="c-icon c-icon-sm cil-plus"></i> Operator</strong></label>
                              <div class="col-md-2">
                                <input class="form-control" type="text" id="operator_id" autocomplete="off" value="">
                              </div>
                              <div class="col-md-5">
                                <input class="form-control" type="text" id="operator_name" value="" readonly>
                              </div>
                              <div class="col-md-3">
                                <button type="button" class="btn btn-pill {% if operation.IsExternalProcess %}bg-plum text-white{% else %}btn-success{% endif %}" id='operator_work_button' onclick="add_topr('{% if operation.IsExternalProcess %}EXT-WORK{% else %}WORKING{% endif %}')" disabled>Start Work</button>
                                {% if operation.MachineType == 'Machine' %}
                                <button type="button" class="btn btn-pill bg-yellowgreen text-white" id='operator_setup_button' onclick="add_topr('SETUP')" disabled>Start Setup</button>
                                {% endif %}
                              </div>
                            </div>
                            <table class="table table-sm table-outline text-center" style="table-layout:fixed;" id="operator_table">
                              <thead class="bg-darkslategray">
                                <tr>
                                  {% if operation.MachineType == 'Machine' %}<th>Machine</th>{% endif %}
                                  <th>Operator</th>
                                  <th>Status</th>
                                  <th>Start-Stop Time</th>
                                  <th></th>
                                </tr>
                              </thead>
                              <tbody id="operator_table_body">

                              </tbody>
                            </table>
                          </div>
                        </div>
                      </div>
                      {% endif %} <!-- *** END CONDITION 2 *** -->
                      {% if operation.JoinToOrderNo != None and operation.JoinToOperationNo != None %} <!-- *** START CONDITION 2 *** -->
                      <!-- Joining -->
                      <div class="col-md-12">
                        <div class="card text-white bg-warning text-center">
                          <div class="card-body text-center">
                            <br><br><br><br><br>
                            <h1><i class="c-icon c-icon-2xl cil-fork" style="font-size: 10rem; width: 10rem;"></i></h1>
                            <br>
                            <h3><strong>THIS OPERATION IS JOINING</strong></h3>
                            <br>
                            <a href="/transaction/{{operation.JoinToOrderNo}}{{operation.JoinToOperationNo}}" class="btn btn-pill btn-lg btn-dark small"><strong>&nbsp;&nbsp;&nbsp;GO TO JOIN OPERATION #{{operation.JoinToOrderNo}}-{{operation.JoinToOperationNo}}&nbsp;&nbsp;&nbsp;</strong></a>
                            <br><br><br><br>><br>
                          </div>
                        </div>
                      </div>
                      {% endif %} <!-- *** END CONDITION 2 *** -->
                      {% else %}<!-- *** ELSE CONDITION 1 *** -->
                      {% if operation.ProcessQty != 0 %} <!-- *** START CONDITION 2 *** -->
                      <!-- Completed Operation -->
                      <div class="col-md-12">
                        <div class="card text-white bg-success text-center">
                          <div class="card-body text-center">
                            <br><br><br><br><br>
                            <h1><i class="c-icon c-icon-2xl cil-check" style="font-size: 10rem; width: 10rem;"></i></h1>
                            <br>
                            <h3><strong>THIS OPERATION IS COMPLETED</strong></h3>
                            <br><br><br><br><br><br>
                          </div>
                        </div>
                      </div>
                      {% endif %} <!-- *** END CONDITION 2 *** -->
                      {% if operation.ProcessQty == 0 %} <!-- *** START CONDITION 2 *** -->
                      <!-- Waiting Operation -->
                      <div class="col-md-12">
                        <div class="card text-white bg-dark text-center">
                          <div class="card-body text-center">
                            <br><br><br><br><br>
                            <h1><i class="c-icon c-icon-2xl cil-puzzle" style="font-size: 10rem; width: 10rem;"></i></h1>
                            <br>
                            <h3><strong>THIS OPERATION IS WAITING</strong></h3>
                            <br><br><br><br><br><br>
                          </div>
                        </div>
                      </div>
                      {% endif %} <!-- *** END CONDITION 2 *** -->
                      {% endif %} <!-- *** END CONDITION 1 *** -->
                    </div>
                  </div>
                </div>
              {% endif%}
              <!-- Not Found -->
              {% if isFirstPage == False and operation == None %}
              <div class="row">
                <div class="col-md-12 text-center">
                  <br><br><br><br><br><br><br><br>
                  <h1><i class="c-icon c-icon-2xl cil-ban" style="font-size: 10rem; width: 10rem;"></i></h1>
                  <br>
                  {% if order == None %}
                  <h1><strong>PRODUCTION ORDER NOT FOUND</strong></h1>
                  {% else %}
                  <h1><strong>OPERATION NOT FOUND</strong></h1>
                  {% endif %}
                  <p>
                    <strong>PRODUCTION NO</strong><br><span class="{% if order == None %}text-danger{% else %}text-success{% endif %}"><strong><span id="nf_order_no">{{orderNo}}</span></strong></span>
                    <br>
                    <strong>OPERATION NO</strong><br><span class="text-danger"><strong><span id="nf_operation_no">{{operationNo}}</span></strong></span>
                  </p>
                  {% if order != None %}
                  {% if currentOperation != -1 %}
                  <a href="/transaction/{{orderNo}}{{currentOperation}}" class="btn btn-pill btn-lg btn-dark small"><strong>&nbsp;&nbsp;&nbsp;GO TO CURRENT OPERATION #{{currentOperation.strip}}&nbsp;&nbsp;&nbsp;</strong></a>
                  {% else %}
                  <p class="text-danger">*** THIS PRODUCTION ORDER HAS ONLY HEADER PLEASE CONTACT ADMIN ***</p>
                  {% endif %}
                  {% endif %}
                </div>
              </div>
              {% endif%}
              <!-- First Page -->
              {% if isFirstPage == True %}
              <div class="row">
                <div class="col-md-12 text-center">
                  <br><br><br><br><br><br><br><br><br><br>
                  <h1><i class="c-icon c-icon-2xl cil-globe-alt" style="font-size: 10rem; width: 10rem;"></i></h1>
                  <br>
                  <h1><strong>SHOPFLOOR REPORTING APPLCATION</strong></h1>
                </div>
              </div>
              {% endif %}
            </div>
          </div>
        </main>
      </div>
      <!-- *** FOOTER *** -->
      {% include 'footer.html' %}
      <!-- *** MODAL *** -->
      <div class="modal fade" id="add_modal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-success" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h4 class="modal-title"><i class="c-icon cil-plus"></i> Add Operation</h4>
              <button class="close" type="button" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
            </div>
            <div class="modal-body">
              <br><h3 class="text-center">Are you sure to add new operation ?</h3><br>
              <div class="form-group row">
                <label class="col-md-4 col-form-label text-right small"><strong>Employee ID</strong></label>
                <div class="col-md-8">
                  <input class="form-control form-control-sm" type="text" id="add_emp_id" autocomplete="off" value="">
                </div>
              </div>
              <div class="form-group row">
                <label class="col-md-4 col-form-label text-right small"><strong>Add Reason</strong></label>
                <div class="col-md-8">
                  <input class="form-control form-control-sm" type="text" id="add_reason" autocomplete="off" value="">
                </div>
              </div>
              <div class="form-group row">
                <label class="col-md-4 col-form-label text-right small"><strong>Operation No</strong></label>
                <div class="col-md-8">
                  <input class="form-control form-control-sm" type="text" id="add_operation_no" autocomplete="off" maxlength="4" value="">
                </div>
              </div>
              <div class="form-group row">
                <label class="col-md-4 col-form-label text-right small"><strong>Work Center</strong></label>
                <div class="col-md-8">
                  <input class="form-control form-control-sm" type="text" id="add_work_center" autocomplete="off" value="">
                </div>
              </div>
              <div class="form-group row">
                <label class="col-md-4 col-form-label text-right small"><strong>Control Key</strong></label>
                <div class="col-md-8">
                  <select class="form-control form-control-sm" id="add_control_key">
                    <option value="PP01" selected>PP01 (Internal Process)</option>
                    <option value="PP02">PP02 (External Process)</option>
                  </select>
                </div>
              </div>
              <div id="add_pp01">
                <div class="form-group row">
                  <label class="col-md-4 col-form-label text-right small"><strong>Est. Setup Time</strong></label>
                  <div class="col-md-8">
                    <input class="form-control form-control-sm" type="number" id="add_est_set_time" autocomplete="off" value="">
                  </div>
                </div>
                <div class="form-group row">
                  <label class="col-md-4 col-form-label text-right small"><strong>Est. Operation Time</strong></label>
                  <div class="col-md-8">
                    <input class="form-control form-control-sm" type="number" id="add_est_operation_time" autocomplete="off" value="">
                  </div>
                </div>
                <div class="form-group row">
                  <label class="col-md-4 col-form-label text-right small"><strong>Est. Labor Time</strong></label>
                  <div class="col-md-8">
                    <input class="form-control form-control-sm" type="number" id="add_est_labor_time" autocomplete="off" value="">
                  </div>
                </div>
              </div>
              <div id="add_pp02" hidden>
                <div class="form-group row">
                  <label class="col-md-4 col-form-label text-right small"><strong>Planned Delivery Time</strong></label>
                  <div class="col-md-8">
                    <input class="form-control form-control-sm" type="text" id="add_pdt" autocomplete="off" value="7" readonly>
                  </div>
                </div>
                <div class="form-group row">
                  <label class="col-md-4 col-form-label text-right small"><strong>Purchasing Org</strong></label>
                  <div class="col-md-8">
                    <input class="form-control form-control-sm" type="text" id="add_purchasing_org" autocomplete="off" value="3000" readonly>
                  </div>
                </div>
                <div class="form-group row">
                  <label class="col-md-4 col-form-label text-right small"><strong>Cost Element</strong></label>
                  <div class="col-md-8">
                    <input class="form-control form-control-sm" type="text" id="add_cost_element" autocomplete="off" value="51202101" readonly>
                  </div>
                </div>
                <div class="form-group row">
                  <label class="col-md-4 col-form-label text-right small"><strong>Material Group</strong></label>
                  <div class="col-md-8">
                    <select class="form-control form-control-sm" id="add_mat_group">
                      {% for materialGroup in materialGroupList %}
                      <option value="{{materialGroup.Code}}">{{materialGroup.Code}} | {{materialGroup.Description}}</option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
                <div class="form-group row">
                  <label class="col-md-4 col-form-label text-right small"><strong>Purchasing Group</strong></label>
                  <div class="col-md-8">
                    <select class="form-control form-control-sm" id="add_purchasing_group">
                      {% for purchaseGroup in purchaseGroupList %}
                      <option value="{{purchaseGroup.ID}}" {% if purchaseGroup.ID.strip == '345' %}selected{% endif %}>{{purchaseGroup.ID}} | {{purchaseGroup.Name}}</option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
                <div class="form-group row">
                  <label class="col-md-4 col-form-label text-right small"><strong>Price</strong></label>
                  <div class="col-md-5">
                    <input class="form-control form-control-sm" type="number" id="add_price" autocomplete="off" value="">
                  </div>
                  <div class="col-md-3">
                    <select class="form-control form-control-sm" id="add_currency">
                      <option value="THB" selected>THB</option>
                      <option value="USD">USD</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-success text-white" type="button" id="add_confirm_button" onclick="add()">Confirm</button>
              <button class="btn btn-secondary" type="button" data-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>
      <div class="modal fade" id="change_modal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-warning" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h4 class="modal-title"><i class="c-icon cil-transfer"></i> Change Operation</h4>
              <button class="close" type="button" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
            </div>
            <div class="modal-body">
              <br><h3 class="text-center">Are you sure to change this operation ?</h3><br>
              <div class="form-group row">
                <label class="col-md-4 col-form-label text-right small"><strong>Employee ID</strong></label>
                <div class="col-md-8">
                  <input class="form-control form-control-sm" type="text" id="change_emp_id" autocomplete="off" value="">
                </div>
              </div>
              <div class="form-group row">
                <label class="col-md-4 col-form-label text-right small"><strong>Change Reason</strong></label>
                <div class="col-md-8">
                  <input class="form-control form-control-sm" type="text" id="change_reason" autocomplete="off" value="">
                </div>
              </div>
              <div class="form-group row">
                <label class="col-md-4 col-form-label text-right small"><strong>Work Center</strong></label>
                <div class="col-md-8">
                  <input class="form-control form-control-sm" type="text" id="change_work_center" autocomplete="off" value="{{operation.WorkCenter}}">
                </div>
              </div>
              <div class="form-group row">
                <label class="col-md-4 col-form-label text-right small"><strong>Control Key</strong></label>
                <div class="col-md-8">
                  <select class="form-control form-control-sm" id="change_control_key">
                    <option value="PP01" selected>PP01 (Internal Process)</option>
                    <option value="PP02">PP02 (External Process)</option>
                  </select>
                </div>
              </div>
              <div id="change_pp01">
                <div class="form-group row">
                  <label class="col-md-4 col-form-label text-right small"><strong>Est. Setup Time</strong></label>
                  <div class="col-md-8">
                    <input class="form-control form-control-sm" type="number" id="change_est_set_time" autocomplete="off" value="{{operation.EstimateSetTime}}">
                  </div>
                </div>
                <div class="form-group row">
                  <label class="col-md-4 col-form-label text-right small"><strong>Est. Operation Time</strong></label>
                  <div class="col-md-8">
                    <input class="form-control form-control-sm" type="number" id="change_est_operation_time" autocomplete="off" value="{{operation.EstimateOoperationTime}}">
                  </div>
                </div>
                <div class="form-group row">
                  <label class="col-md-4 col-form-label text-right small"><strong>Est. Labor Time</strong></label>
                  <div class="col-md-8">
                    <input class="form-control form-control-sm" type="number" id="change_est_labor_time" autocomplete="off" value="{{operation.EstimateLaborTime}}">
                  </div>
                </div>
              </div>
              <div id="change_pp02" hidden>
                <div class="form-group row">
                  <label class="col-md-4 col-form-label text-right small"><strong>Planned Delivery Time</strong></label>
                  <div class="col-md-8">
                    <input class="form-control form-control-sm" type="text" id="change_pdt" autocomplete="off" value="7" readonly>
                  </div>
                </div>
                <div class="form-group row">
                  <label class="col-md-4 col-form-label text-right small"><strong>Purchasing Org</strong></label>
                  <div class="col-md-8">
                    <input class="form-control form-control-sm" type="text" id="change_purchasing_org" autocomplete="off" value="3000" readonly>
                  </div>
                </div>
                <div class="form-group row">
                  <label class="col-md-4 col-form-label text-right small"><strong>Cost Element</strong></label>
                  <div class="col-md-8">
                    <input class="form-control form-control-sm" type="text" id="change_cost_element" autocomplete="off" value="51202101" readonly>
                  </div>
                </div>
                <div class="form-group row">
                  <label class="col-md-4 col-form-label text-right small"><strong>Material Group</strong></label>
                  <div class="col-md-8">
                    <select class="form-control form-control-sm" id="change_mat_group">
                      {% for materialGroup in materialGroupList %}
                      <option value="{{materialGroup.Code}}">{{materialGroup.Code}} | {{materialGroup.Description}}</option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
                <div class="form-group row">
                  <label class="col-md-4 col-form-label text-right small"><strong>Purchasing Group</strong></label>
                  <div class="col-md-8">
                    <select class="form-control form-control-sm" id="change_purchasing_group">
                      {% for purchaseGroup in purchaseGroupList %}
                      <option value="{{purchaseGroup.ID}}" {% if purchaseGroup.ID.strip == '345' %}selected{% endif %}>{{purchaseGroup.ID}} | {{purchaseGroup.Name}}</option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
                <div class="form-group row">
                  <label class="col-md-4 col-form-label text-right small"><strong>Price</strong></label>
                  <div class="col-md-5">
                    <input class="form-control form-control-sm" type="number" id="change_price" autocomplete="off" value="">
                  </div>
                  <div class="col-md-3">
                    <select class="form-control form-control-sm" id="change_currency">
                      <option value="THB" selected>THB</option>
                      <option value="USD">USD</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-warning text-white" type="button" id="change_confirm_button" onclick="change()">Confirm</button>
              <button class="btn btn-secondary" type="button" data-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>
      <div class="modal fade" id="delete_modal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-danger" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h4 class="modal-title"><i class="c-icon cil-trash"></i> Delete Operation</h4>
              <button class="close" type="button" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
            </div>
            <div class="modal-body">
              <br><h3 class="text-center">Are you sure to delete this operation ?</h3><br>
              <div class="form-group row">
                <label class="col-md-4 col-form-label text-right small"><strong>Employee ID</strong></label>
                <div class="col-md-8">
                  <input class="form-control form-control-sm" type="text" id="delete_emp_id" autocomplete="off" value="">
                </div>
              </div>
              <div class="form-group row">
                <label class="col-md-4 col-form-label text-right small"><strong>Delete Reason</strong></label>
                <div class="col-md-8">
                  <input class="form-control form-control-sm" type="text" id="delete_reason" autocomplete="off" value="">
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-danger" type="button" id="trash_confirm_button" onclick="trash()">Confirm</button>
              <button class="btn btn-secondary" type="button" data-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>
      <div class="modal fade" id="join_list_modal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-primary" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h4 class="modal-title"><i class="c-icon cil-list"></i> Join List ({{joinList|length}})</h4>
              <button class="close" type="button" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
            </div>
            <div class="modal-body">
              <table class="table table-sm table-responsive-sm table-outline text-center">
                <thead class="bg-darkslategray">
                  <tr>
                    <th>No</th>
                    <th>Production Order</th>
                    <th>Operation No</th>
                  </tr>
                </thead>
                <tbody>
                  {% for item in joinList %}
                  <tr>
                    <td>{{forloop.counter}}</td>
                    <td>{{item.ProductionOrderNo}}</td>
                    <td>{{item.OperationNumber}}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" type="button" data-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>
      <div class="modal fade" id="history_modal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-info modal-lg" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h4 class="modal-title"><i class="c-icon cil-history"></i> History</h4>
              <button class="close" type="button" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
            </div>
            <div class="modal-body">
              <div class="nav-tabs-boxed">
                <ul class="nav nav-tabs" role="tablist">
                  <li class="nav-item"><a class="nav-link active" data-toggle="tab" href="#operate-tab" role="tab" aria-controls="home">Operate</a></li>
                  <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#confirm-tab" role="tab" aria-controls="profile">Confirm</a></li>
                </ul>
                <div class="tab-content">
                  <!-- Operate Tab -->
                  <div class="tab-pane active" id="operate-tab" role="tabpanel">
                    <table class="table table-sm table-responsive-sm table-outline small">
                      <thead class="bg-darkslategray">
                        <tr>
                          <th>Operator</th>
                          <th>Machine</th>
                          <th>Type</th>
                          <th>Start Time</th>
                          <th>Finish Time</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td>5731</td>
                          <td>BTA-01</td>
                          <td>SETUP</td>
                          <td>28-10-2021 10:05</td>
                          <td>28-10-2021 11:23</td>
                        </tr>
                        <tr>
                          <td>5731</td>
                          <td>BTA-01</td>
                          <td>WORK</td>
                          <td>28-10-2021 10:05</td>
                          <td>28-10-2021 11:23</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                  <!-- Confirm Tab -->
                  <div class="tab-pane" id="confirm-tab" role="tabpanel">
                    <table class="table table-sm table-responsive-sm table-outline small">
                      <thead class="bg-darkslategray">
                        <tr>
                          <th>Operator</th>
                          <th>Machine</th>
                          <th>Good Qty</th>
                          <th>Reject Qty</th>
                          <th>Reason</th>
                          <th>Confirm Time</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td>5731</td>
                          <td>BTA-01</td>
                          <td>3</td>
                          <td>0</td>
                          <td>-</td>
                          <td>28-10-2021 17:24</td>
                        </tr>
                        <tr>
                          <td>5731</td>
                          <td>BTA-01</td>
                          <td>2</td>
                          <td>1</td>
                          <td>RUST</td>
                          <td>28-10-2021 17:24</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" type="button" data-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>
      <div class="modal fade" id="confirm_modal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg modal-primary" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h4 class="modal-title"><i class="c-icon cil-star"></i> Confirm</h4>
              <button class="close" type="button" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
            </div>
            <div class="modal-body">
              <input type="text" id="confirm_id" hidden>
              <div class="col-md-12">
                <div class="form-group row">
                  <label class="col-md-3 col-form-label text-right"><strong>Operator</strong></label>
                  <div class="col-md-7">
                    <input class="form-control" type="text" id="confirm_operator" readonly>
                  </div>
                </div>
                {% if operation.MachineType == 'Machine' %}
                <div class="form-group row">
                  <label class="col-md-3 col-form-label text-right"><strong>Machine</strong></label>
                  <div class="col-md-7">
                    <input class="form-control" type="text" id="confirm_machine" readonly>
                  </div>
                </div>
                {% endif %}
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group row">
                      <label class="col-md-4 col-form-label text-right"><strong>Start Time</strong></label>
                      <div class="col-md-8">
                        <input class="form-control" type="text" id="confirm_start_time" readonly>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group row">
                      <label class="col-md-4 col-form-label text-right"><strong>Stop Time</strong></label>
                      <div class="col-md-8">
                        <input class="form-control" type="text" id="confirm_stop_time" readonly>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group row">
                      <label class="col-md-4 col-form-label text-right text-success"><strong>Good Qty</strong></label>
                      <div class="col-md-8">
                        <input class="form-control" type="number" id="good_qty" autocomplete="off" value="0">
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group row">
                      <label class="col-md-4 col-form-label text-right text-danger"><strong>Reject Qty</strong></label>
                      <div class="col-md-8">
                        <input class="form-control" type="number" id="reject_qty" autocomplete="off" value="0">
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group row">
                      <label class="col-md-4 col-form-label text-right"><strong>Reason</strong></label>
                      <div class="col-md-8">
                        <select class="form-control" id="reject_reason">
                          <option value="-1" selected>-</option>
                          {% for rejectReason in rejectReasonList %}
                          <option value="{{rejectReason.Name.strip}}">{{rejectReason.Name}}</option>
                          {% endfor %}
                        </select>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group row">
                      <label class="col-md-4 col-form-label text-right"><strong>Other</strong></label>
                      <div class="col-md-8">
                        <input class="form-control" type="text" id="other_reason" autocomplete="off" readonly>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="text-danger text-center small" id="confirm_invalid_text"></div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-primary" type="button" id="confirm_button" onclick="confirm()">Confirm</button>
              <button class="btn btn-secondary" type="button" data-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- CoreUI and necessary plugins-->
    <script src="{% static "vendors/@coreui/coreui-pro/js/coreui.bundle.min.js" %}"></script>
    <!--[if IE]><!-->
    <script src="{% static "vendors/@coreui/icons/js/svgxuse.min.js" %}"></script>
    <!--<![endif]-->
    <script src="{% static "vendors/jquery/js/jquery.min.js" %}"></script>
    <!-- SELECT JS -->
    <script src="{% static "vendors/select2/js/select2.min.js" %}"></script>
    <!-- Popover JS -->
    <script src="{% static "js/popovers.js" %}"></script>
    <!-- Custom JS -->
    <script src="{% static "customize/js/clock.js" %}"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function(event) {
        setTimeout(function() {
          document.body.classList.remove('c-no-layout-transition')
        }, 2000);
      });

      //-- INITIALIZE
      var isSearchingMachine = false;
      var isSearchingOperator = false;
      var currentMachineNo = null;
      var currentOperatorId = null;

      $(document).ready(function() {
        showTime();
        if($("#has_data").val() == "true" && $("#remain_qty").val() > 0){
          if($("#machine_type").val() == 'Machine') reload_machine_table();
          reload_operator_table();
        }
      });

      //-- MAIN SCRIPT
      $("#machine_no").on("change keyup", function() {
        $('#machine_name').val('');
        $('#machine_add_button').prop('disabled', true);
        remove_valid('machine_name');
        $('#machine_name').removeClass('text-danger');
        var machine_no = $('#machine_no').val();
        if(isSearchingMachine == false && machine_no.length >= 4){
          isSearchingMachine = true;
          $.ajax({
            url: '/get_machine_data/',
            data: {
              'machine_no': machine_no,
            },
            dataType: 'json',
            success: function (data) {
              if (data.canAdd) {
                currentMachineNo = data.MachineNumber;
                currentMachineName = data.MachineName;
                $('#machine_name').val(data.MachineNumber+" | "+data.MachineName);
                $('#machine_add_button').prop('disabled', false);
                valid('machine_name');
                $('#machine_name').addClass('text-success');
              } else {
                $('#machine_name').val(data.invalid_text);
                invalid('machine_name');
                $('#machine_name').addClass('text-danger');
              }
              isSearchingMachine = false;
            }
          });
        }
      });

      $("#operator_id").on("change keyup", function() {
        $('#operator_name').val('');
        $('#operator_work_button').prop('disabled', true);
        $('#operator_setup_button').prop('disabled', true);
        remove_valid('operator_name');
        $('#operator_name').removeClass('text-danger');
        var operator_id = $('#operator_id').val();
        if(isSearchingOperator == false && operator_id.length >= 4){
          isSearchingOperator = true;
          $.ajax({
            url: '/get_operator_data/',
            data: {
              'operator_id': operator_id,
            },
            dataType: 'json',
            success: function (data) {
              if (data.canAdd) {
                $('#operator_work_button').prop('disabled', false);
                $('#operator_setup_button').prop('disabled', false);
                currentOperatorId = data.EmpID;
                currentOperatorName = data.EmpName;
                $('#operator_name').val(data.EmpID+" | "+data.EmpName+" ("+data.Department+")");
                valid('operator_name');
                $('#operator_name').addClass('text-success');
              } else {
                $('#operator_name').val(data.invalid_text);
                invalid('operator_name');
                $('#operator_name').addClass('text-danger');
              }
              isSearchingOperator = false;
            }
          });
        }
      });
      //---------------------------------------------------------------------------------------------------- TABLES
      function create_machine_table(){
        var order_no = $("#order_no").val();
        var operation_no = $("#operation_no").val();
        $.ajax({
          url: '/get_all_tmc/',
          data: {
            'order_no': order_no,
            'operation_no': operation_no,
          },
          dataType: 'json',
          success: function (data) {
            var completed_count = 0;
            if(data.tmcList.length == 0){
              var row = "<tr><td colspan='5'>Please add machine above.</td></tr>";
              $("#machine_table_body").append(row);
            } else {
              for(var i = 0;i < data.tmcList.length;i++){
                var tmc = data.tmcList[i];
                var row = "";
                // console.log(tmc);
                for(var j = 0;j < tmc.length;j++){
                  var tmc_id = tmc[0];
                  var tmc_machine_name = tmc[8]+" | "+tmc[9];
                  var tmc_startdatetime = tmc[4];
                  var startdatetime = (tmc_startdatetime == null)?"-":getFullDateTime(tmc_startdatetime);
                  var tmc_stopdatetime = tmc[5];
                  var stopdatetime = (tmc_stopdatetime == null)?"-":getFullDateTime(tmc_stopdatetime);
                  var tmc_status = $.trim(tmc[6]);
                  var mc_type = $.trim(tmc[11]);
                  if(tmc_status == "COMPLETED") {
                    completed_count++;
                    break;
                  }
                  row = "";
                  row += "<tr id='machine_row_"+tmc_id+"'>";
                  row += "<td>";
                  if(tmc_status != "SETUP"){
                    row += "<input type='radio' class='my-radio' name='machine_radio' value='"+tmc_id+"' checked>";
                  }
                  row += "</td>";
                  row += "<td class='small'>"+tmc_machine_name+"</td>";
                  row += (tmc_status == "WAITING")?"<td class='font-weight-bold'>":"<td class='blink font-weight-bold'>";
                  row += tmc_status;
                  row += "<input type='text' id='machine_status_"+tmc_id+"' value='"+tmc_status+"' hidden>";
                  row += "</td>";
                  row += "<td class='small'>";
                  row += "<div>"+startdatetime+"</div>";
                  row += "</td>";
                  row += "<td>";
                  if(tmc_status == "WAITING"){
                    row += "<button type='button' class='btn btn-sm btn-pill btn-dark small' id='delete_tmc_"+tmc_id+"' onclick='delete_tmc("+tmc_id+")'>Delete</button>";
                  } else if (tmc_status == "WORKING" && mc_type == "Auto" && data.hasOperatorWorkingList[i] == false){
                    row += "<button type='button' class='btn btn-sm btn-pill btn-danger small' id='stop_mc_tmc_"+tmc_id+"' onclick='stop_mc_tmc("+tmc_id+")'>Stop Machine</button>";
                  }
                  row += "</td>";
                  row += "</tr>";
                }
                $("#machine_table_body").append(row);
                dynamic_operator_setup();
              }
              if(completed_count == data.tmcList.length){
                var row = "<tr><td colspan='5'>Please add machine above.</td></tr>";
                $("#machine_table_body").append(row);
              }
            }
            dynamic_operator_id();
          }
        });
      }

      function create_operator_table(){
        var order_no = $("#order_no").val();
        var operation_no = $("#operation_no").val();
        var machine_type = $("#machine_type").val();
        $.ajax({
          url: '/get_all_topr/',
          data: {
            'order_no': order_no,
            'operation_no': operation_no,
          },
          dataType: 'json',
          success: function (data) {
            if(data.toprList.length == 0){
              var row = "<tr><td colspan='"+((machine_type == 'Machine')?5:4)+"'>Please add operator above.</td></tr>";
              $("#operator_table_body").append(row);
            } else {
              for(var i = 0;i < data.toprList.length;i++){
                var topr = data.toprList[i];
                var row = "";
                // console.log(topr);
                for(var j = 0;j < topr.length;j++){
                  var topr_id = topr[0];
                  var topr_machine_name = (topr[19] == null)?null:topr[19]+" | "+topr[20];
                  var topr_operator_name = topr[1]+" | "+topr[9];
                  var topr_startdatetime = topr[3];
                  var startdatetime = (topr_startdatetime == null)?"-":getFullDateTime(topr_startdatetime);
                  var topr_stopdatetime = topr[4];
                  var stopdatetime = (topr_stopdatetime == null)?"-":getFullDateTime(topr_stopdatetime);
                  var topr_status = $.trim(topr[5]);
                  row = "";
                  row += "<tr id='operator_row_"+topr_id+"'>";
                  row += (topr_machine_name == null)? "":"<td class='small'>"+topr_machine_name+"</td>";
                  row += "<td class='small'>"+topr_operator_name+"</td>";
                  row += (topr_status == 'COMPLETED')?"<td class='text-success font-weight-bold'>":"<td class='blink font-weight-bold'>";
                  row += topr_status+"</td>";
                  row += "<td class='small'>";
                  row += "<div> <strong>START</strong> "+startdatetime+"</div>";
                  row += "<div> <strong>STOP</strong> "+stopdatetime+"</div>";
                  row += "</td>";
                  row += "<td>";
                  if(topr_status == "WORKING" || topr_status == "EXT-WORK"){
                    row += "<button type='button' class='btn btn-sm btn-pill btn-danger small' id='stop_work_topr_"+topr_id+"' onclick='stop_work_topr("+topr_id+")'>Stop Working</button>";
                  } else if (topr_status == "SETUP"){
                    row += "<button type='button' class='btn btn-sm btn-pill btn-success small' id='start_work_topr_"+topr_id+"' onclick='start_work_topr("+topr_id+")'>Start Working</button> ";
                    row += "<button type='button' class='btn btn-sm btn-pill btn-warning text-white small' id='stop_setup_topr_"+topr_id+"' onclick='stop_setup_topr("+topr_id+")'>Stop Setup & Exit</button>";
                  } else if (topr_status == "COMPLETED" && $('#remain_qty').val() > 0){
                    row += "<button type='button' class='btn btn-sm btn-pill btn-primary small' onclick='prepare_confirm("+topr_id+")' data-toggle='modal' data-target='#confirm_modal'>Confirm</button>";
                  }
                  row += "</td>";
                  row += "</tr>";
                }
                $("#operator_table_body").append(row);
              }
            }
          }
        });
      }

      function reload_machine_table(){
        $("#machine_table > tbody").empty();
        create_machine_table();
      }

      function reload_operator_table(){
        $("#operator_table > tbody").empty();
        create_operator_table();
      }

      //---------------------------------------------------------------------------------------------------- MACHINE
      function add_tmc(){
        $('#machine_add_button').prop('disabled', true);
        var order_no = $("#order_no").val();
        var operation_no = $("#operation_no").val();
        $.ajax({
          url: '/add_tmc/',
          data: {
            'order_no': order_no,
            'operation_no': operation_no,
            'machine_no': currentMachineNo,
          },
          dataType: 'json',
          success: function (data) {
            $('#machine_no').val("");
            $('#machine_name').val("");
            remove_valid('machine_name');
            reload_machine_table();
          }
        });
      }

      function delete_tmc(id){
        $('#delete_tmc_' + id).prop('disabled', true);
        $.ajax({
          url: '/delete_tmc/',
          data: {
            'id': id,
          },
          dataType: 'json',
          success: function (data) {
            reload_machine_table();
          }
        });
      }

      function stop_mc_tmc(id){
        $('#stop_mc_tmc_' + id).prop('disabled', true);
        $.ajax({
          url: '/stop_mc_tmc/',
          data: {
            'id': id,
          },
          dataType: 'json',
          success: function (data) {
            reload_machine_table();
          }
        });
      }
      //---------------------------------------------------------------------------------------------------- OPERATOR
      function add_topr(status){
        $('#operator_work_button').prop('disabled', true);
        $('#operator_setup_button').prop('disabled', true);
        var order_no = $("#order_no").val();
        var operation_no = $("#operation_no").val();
        var tmc_id = "NULL";
        if ($('input[name="machine_radio"]').length > 0){
          tmc_id = document.querySelector('input[name="machine_radio"]:checked').value;
        }
        $.ajax({
          url: '/add_topr/',
          data: {
            'order_no': order_no,
            'operation_no': operation_no,
            'operator_id': currentOperatorId,
            'tmc_id': tmc_id,
            'status': status,
          },
          dataType: 'json',
          success: function (data) {
            $('#operator_id').val("");
            $('#operator_name').val("");
            remove_valid('operator_name');
            if($("#machine_type").val() == 'Machine') reload_machine_table();
            reload_operator_table();
          }
        });
      }

      function start_work_topr(id){
        $('#start_work_topr_' + id).prop('disabled', true);
        $.ajax({
          url: '/start_work_topr/',
          data: {
            'id': id,
          },
          dataType: 'json',
          success: function (data) {
            if($("#machine_type").val() == 'Machine') reload_machine_table();
            reload_operator_table();
          }
        });
      }

      function stop_setup_topr(id){
        $('#stop_setup_topr_' + id).prop('disabled', true);
        $.ajax({
          url: '/stop_setup_topr/',
          data: {
            'id': id,
          },
          dataType: 'json',
          success: function (data) {
            if($("#machine_type").val() == 'Machine') reload_machine_table();
            reload_operator_table();
          }
        });
      }

      function stop_work_topr(id){
        $('#stop_work_topr_' + id).prop('disabled', true);
        $.ajax({
          url: '/stop_work_topr/',
          data: {
            'id': id,
          },
          dataType: 'json',
          success: function (data) {
            if($("#machine_type").val() == 'Machine') reload_machine_table();
            reload_operator_table();
          }
        });
      }

      function prepare_confirm(id){
        $('#confirm_button').prop('disabled', true);
        $.ajax({
          url: '/get_topr_for_confirm/',
          data: {
            'id': id,
          },
          dataType: 'json',
          success: function (data) {
            $('#confirm_id').val(id);
            $('#confirm_operator').val(data.operator_text);
            $('#confirm_machine').val(data.machine_text);
            $('#confirm_start_time').val(data.start_time);
            $('#confirm_stop_time').val(data.stop_time);
            $('#confirm_button').prop('disabled', false);
          }
        });
      }
      //----------------------------------------------------------------------------------------------------

      //-- ADD OPERATION
      function add(){
        $('#add_confirm_button').prop('disabled', true);
        var order_no = $("#order_no").val();
        var emp_id = $("#add_emp_id").val();
        var reason = $("#add_reason").val();
        var operation_no = $("#add_operation_no").val();
        var work_center = $("#add_work_center").val();
        var control = $("#add_control_key").val();
        remove_valid_many(["add_emp_id","add_reason","add_operation_no","add_work_center"]);
        validate_operator(emp_id, function(result){
          if(!result){
            invalid("add_emp_id");
          } else if (reason.length == 0){
            valid("add_emp_id");
            invalid("add_reason");
          } else {
            valid_many(["add_emp_id","add_reason"]);
            validate_new_operation(order_no, operation_no, function(result){
              if(!result){
                invalid("add_operation_no");
              } else if (work_center.length == 0){
                valid("add_operation_no");
                invalid("add_work_center");
              } else {
                valid_many(["add_operation_no","add_work_center"]);
                //-- DO SOMETHING
              }
           });
          }
        });
        $('#add_confirm_button').prop('disabled', false);
      }

      //-- CHANGE OPERATION
      function change(){
        $('#change_confirm_button').prop('disabled', true);
        var emp_id = $("#change_emp_id").val();
        var reason = $("#change_reason").val();
        var work_center = $("#change_work_center").val();
        remove_valid_many(["change_emp_id","change_reason","change_work_center"]);
        validate_operator(emp_id, function(result){
          if(!result){
            invalid("change_emp_id");
          } else if (reason.length == 0){
            valid("change_emp_id");
            invalid("change_reason");
          } else if (work_center.length == 0){
            valid_many(["change_emp_id","change_reason"]);
            invalid("change_work_center");
          } else {
            valid_many(["change_emp_id","change_reason","change_work_center"]);
            //-- DO SOMETHING
          }
        });
        $('#change_confirm_button').prop('disabled', false);
      }

      //-- DELETE OPERATION
      function trash(){
        $('#trash_confirm_button').prop('disabled', true);
        var emp_id = $("#delete_emp_id").val();
        var reason = $("#delete_reason").val();
        remove_valid_many(["change_emp_id", "delete_reason"]);
        validate_operator(emp_id, function(result){
          if(!result){
            invalid("delete_emp_id");
          } else if (reason.length == 0){
            valid("delete_emp_id");
            invalid("delete_reason");
          } else {
            valid_many(["delete_emp_id","delete_reason"]);
            //-- DO SOMETHING
          }
        });
        $('#trash_confirm_button').prop('disabled', false);
      }

      // CONFIRM
      function confirm(){
        $("#confirm_invalid_text").text("");
        if($('#good_qty').val() == "") $('#good_qty').val("0");
        if($('#reject_qty').val() == "") $('#reject_qty').val("0");
        var remain_qty = parseFloat($('#remain_qty').val());
        var good_qty = parseFloat($('#good_qty').val());
        var reject_qty = parseFloat($('#reject_qty').val());
        var reject_reason = $('#reject_reason').val();
        var other_reason = $('#other_reason').val();
        if(good_qty <= 0 && reject_qty <= 0) $("#confirm_invalid_text").text("Good Qty + Reject Qty can not be 0");
        else if(remain_qty < good_qty + reject_qty) $("#confirm_invalid_text").text("Good Qty + Reject Qty can not be more than Remaining Qty");
        else if(reject_qty > 0 && reject_reason == -1) $("#confirm_invalid_text").text("Please select reject reason");
        else if(reject_reason == 0 && other_reason == "") $("#confirm_invalid_text").text("Please fill reason in other reason field");
        else if(other_reason.includes("|")) $("#confirm_invalid_text").text("character | is not allow to use.");
        else {
          //-- DO SOMETHING
        }
      }

      //-- VALIDATION
      function validate_operator(emp_id, _callback){
        if(emp_id.length == 0) {
          _callback(false);
          return;
        } else {
          $.ajax({
            url: '/validate_operator/',
            data: {
              'emp_id': emp_id,
            },
            dataType: 'json',
            success: function (data) {
              if (data.isExist) {
                _callback(true);
                return;
              } else {
                _callback(false);
                return;
              }
            }
          });
        }
      }

      function validate_new_operation(order_no, new_operation_no, _callback){
        var current_operation_no = $("#operation_no").val();
        if(new_operation_no.length != 4 || new_operation_no <= current_operation_no) { //-- NEED FIX
          _callback(false);
          return;
        } else {
          $.ajax({
            url: '/validate_new_operation/',
            data: {
              'order_no': order_no,
              'current_operation_no': current_operation_no,
              'new_operation_no': new_operation_no,
            },
            dataType: 'json',
            success: function (data) {
              if (data.canAdd) {
                _callback(true);
                return;
              } else {
                _callback(false);
                return;
              }
            }
          });
        }
      }

      //-- SHORTCUT SEARCH
      document.getElementById("sc_order_no").addEventListener("keydown", function (e) {
            if (e.code === "Enter" || e.code == "NumpadEnter") shortcut_search();
        });

      document.getElementById("sc_order_no").addEventListener("keyup", function (e) {
            if ($("#sc_order_no").val().length == 10) $("#sc_operation_no").focus();
        });

      document.getElementById("sc_operation_no").addEventListener("keydown", function (e) {
            if (e.code === "Enter" || e.code == "NumpadEnter") shortcut_search();
        });

      function shortcut_search(){
          var order_no =  $("#sc_order_no").val();
          var operation_no =  $("#sc_operation_no").val();
          (order_no.length != 10)? invalid("sc_order_no"): valid("sc_order_no");
          (operation_no.length != 4)? invalid("sc_operation_no"): valid("sc_operation_no");
          if(order_no.length == 10 && operation_no.length == 4){
            remove_valid_many(["sc_order_no","sc_operation_no"]);
            window.open('/transaction/' + order_no + operation_no, '_self');
          }
        }

      //-- VALIDATE CONTROL
      remove_valid_many = (input_ids) => { for(var i = 0;i < input_ids.length;i++) remove_valid(input_ids[i]); }
      valid_many = (input_ids) => { for(var i = 0;i < input_ids.length;i++) valid(input_ids[i]); }

      function remove_valid(input_id){
        $("#"+input_id).removeClass("is-invalid");
        $("#"+input_id).removeClass("is-valid");
      }

      function valid(input_id){
        $("#"+input_id).addClass("is-valid");
        $("#"+input_id).removeClass("is-invalid");
      }

      function invalid(input_id){
        $("#"+input_id).addClass("is-invalid");
        $("#"+input_id).removeClass("is-valid");
      }

      //-- DYNAMIC INPUT
      $(document).on('change', 'input[type=radio][name=machine_radio]', function (event) {
          dynamic_operator_setup();
      });

      function dynamic_operator_setup(){
        if ($('input[name="machine_radio"]').length > 0){
          tmc_id = document.querySelector('input[name="machine_radio"]:checked').value;
          var tmc_status = $('#machine_status_' + tmc_id).val();
          if(tmc_status == "WORKING"){
            $("#operator_setup_button").prop('hidden', true);
          } else {
            $("#operator_setup_button").prop('hidden', false);
          }
        }
      }

      function dynamic_operator_id(){
        if($('#machine_type').val() == 'Labor'){
          $("#operator_id").prop('readonly', false);
        } else if($('#machine_type').val() == 'Machine' && $('input[name="machine_radio"]').length > 0){
          $("#operator_id").prop('readonly', false);
        } else {
          $("#operator_id").prop('readonly', true);
        }
      }

      $('#reject_reason').on("change", function() {
        if($('#reject_reason').val() != 0){
          $("#other_reason").prop("readonly", true);
          $("#other_reason").val("");
        } else {
          $("#other_reason").prop("readonly", false)
        }
      });

      $('#add_control_key').on("change", function() {
        ($('#add_control_key').val() == "PP01")? $("#add_pp01").prop("hidden", false): $("#add_pp01").prop("hidden", true);
        ($('#add_control_key').val() == "PP01")? $("#add_pp02").prop("hidden", true): $("#add_pp02").prop("hidden", false);
      });

      $('#change_control_key').on("change", function() {
        ($('#change_control_key').val() == "PP01")? $("#change_pp01").prop("hidden", false): $("#change_pp01").prop("hidden", true);
        ($('#change_control_key').val() == "PP01")? $("#change_pp02").prop("hidden", true): $("#change_pp02").prop("hidden", false);
      });

      //-- KET RESTRICT
      $("#add_est_set_time").on("keypress keyup blur",function (event) {
          $(this).val($(this).val().replace(/[^\d].+/, ""));
          if((event.which < 48 || event.which > 57)) event.preventDefault();
      });

      $("#add_est_operation_time").on("keypress keyup blur",function (event) {
          $(this).val($(this).val().replace(/[^\d].+/, ""));
          if((event.which < 48 || event.which > 57)) event.preventDefault();
      });

      $("#add_est_labor_time").on("keypress keyup blur",function (event) {
          $(this).val($(this).val().replace(/[^\d].+/, ""));
          if((event.which < 48 || event.which > 57)) event.preventDefault();
      });

      $("#add_operation_no").on("keypress keyup blur",function (event) {
          $(this).val($(this).val().replace(/[^\d].+/, ""));
          if((event.which < 48 || event.which > 57)) event.preventDefault();
      });

      $("#add_pdt").on("keypress keyup blur",function (event) {
          $(this).val($(this).val().replace(/[^\d].+/, ""));
          if((event.which < 48 || event.which > 57)) event.preventDefault();
      });

      $("#change_est_set_time").on("keypress keyup blur",function (event) {
          $(this).val($(this).val().replace(/[^\d].+/, ""));
          if((event.which < 48 || event.which > 57)) event.preventDefault();
      });

      $("#change_est_operation_time").on("keypress keyup blur",function (event) {
          $(this).val($(this).val().replace(/[^\d].+/, ""));
          if((event.which < 48 || event.which > 57)) event.preventDefault();
      });

      $("#change_est_labor_time").on("keypress keyup blur",function (event) {
          $(this).val($(this).val().replace(/[^\d].+/, ""));
          if((event.which < 48 || event.which > 57)) event.preventDefault();
      });

      $("#change_pdt").on("keypress keyup blur",function (event) {
          $(this).val($(this).val().replace(/[^\d].+/, ""));
          if((event.which < 48 || event.which > 57)) event.preventDefault();
      });

      $("#operator_id").on("keypress keyup blur",function (event) {
          $(this).val($(this).val().replace(/[^\d].+/, ""));
          if((event.which < 48 || event.which > 57)) event.preventDefault();
      });

      $("#good_qty").on("keypress keyup blur",function (event) {
          $(this).val($(this).val().replace(/[^\d].+/, ""));
          if((event.which < 48 || event.which > 57)) event.preventDefault();
      });

      $("#reject_qty").on("keypress keyup blur",function (event) {
         $(this).val($(this).val().replace(/[^\d].+/, ""));
         if((event.which < 48 || event.which > 57)) event.preventDefault();
      });

      $("#sc_order_no").on("keypress keyup blur",function (event) {
         $(this).val($(this).val().replace(/[^\d].+/, ""));
         if((event.which < 48 || event.which > 57)) event.preventDefault();
       });

       $("#sc_operation_no").on("keypress keyup blur",function (event) {
           $(this).val($(this).val().replace(/[^\d].+/, ""));
           if((event.which < 48 || event.which > 57)) event.preventDefault();
        });

        //-- ETC
        function capitalizeFirstLetter(str) {
           return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function getFullDateTime(str) {
           var result = "";
           var year = new Date(str).getFullYear();
           var month = frontZero((new Date(str).getMonth() + 1).toString());
           var date = frontZero(new Date(str).getDate().toString());
           var hour = frontZero(new Date(str).getHours().toString());
           var minute = frontZero(new Date(str).getMinutes().toString());
           var second = frontZero(new Date(str).getSeconds().toString());
           result = date+"-"+month+"-"+year+", "+hour+":"+minute+":"+second;
           return result
        }

        function frontZero(str){
          return (str.length != 2)?"0"+str:str;
        }
    </script>
  </body>
</html>
